import base64

def escape_powershell_literal(cmd):
    # Escape singoli apici per PowerShell
    return cmd.replace("'", "''")

def to_unicode(cmd):
    # Codifica UTF-16LE come richiesto da PowerShell -EncodedCommand
    return cmd.encode('utf-16le')

def encode_buf(buf):
    escaped = escape_powershell_literal(buf)
    full_cmd = f"cmd.exe /c '{escaped}'"
    encoded = base64.b64encode(to_unicode(full_cmd)).decode()
    return f"powershell -w hidden -nop -e {encoded}"

def encode_block(buf, badchars=None):
    if not badchars:
        return buf

    if '-' in badchars or ' ' in badchars:
        return buf

    cmd = encode_buf(buf)

    if '=' in badchars:
        while '=' in cmd:
            buf += ' '
            cmd = encode_buf(buf)

    return cmd

# ðŸ”§ Esempio d'uso
if __name__ == "__main__":
    comando = "whoami"
    badchars = []  # oppure ad esempio ['=']
    risultato = encode_block(comando, badchars)
    print(risultato)
